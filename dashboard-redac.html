<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mes Cinédocs | Cloud</title>
    <link rel="icon" type="image/png" href="NEXUS.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #fdfdfd; --text: #1a1a1a; --accent: #e50914; --border: #eee; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); }
        nav { padding: 20px 5%; border-bottom: 1px solid var(--border); background: white; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-family: 'Playfair Display', serif; font-weight: 700; font-size: 1.2rem; text-decoration: none; color: #111; }
        .container { max-width: 1000px; margin: 50px auto; padding: 0 20px; }
        .docs-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
        .new-doc-btn { border: 2px dashed #ccc; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 250px; cursor: pointer; text-decoration: none; color: #888; font-size: 3rem; transition: 0.3s; }
        .new-doc-btn:hover { border-color: var(--accent); color: var(--accent); background: #fffafa; }
        .doc-card { background: white; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; position: relative; transition: 0.3s; display: flex; flex-direction: column; }
        .doc-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .card-img { width: 100%; aspect-ratio: 16/9; object-fit: cover; background: #eee; }
        .card-body { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; }
        .btn-delete { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; z-index: 2; }
        #status { font-size: 0.7rem; color: #aaa; text-transform: uppercase; letter-spacing: 1px; }

        /* NOUVEAUX STYLES POUR BROUILLONS ET MODIFICATION */
        .status-badge { font-size: 0.65rem; padding: 4px 10px; border-radius: 50px; font-weight: 700; display: inline-block; margin-bottom: 10px; width: fit-content; }
        .badge-brouillon { background: #f0f0f0; color: #666; }
        .badge-publie { background: #e5f9e5; color: #28a745; border: 1px solid #d4edda; }
        
        .btn-edit { margin-top: auto; text-decoration: none; background: #1a1a1a; color: white; text-align: center; padding: 10px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; transition: 0.2s; }
        .btn-edit:hover { background: var(--accent); }
    </style>
</head>
<body>

    <nav>
        <a href="index.html" class="logo">NEXUS / CINEDOC</a>
        <div id="status">Chargement...</div>
    </nav>

    <div class="container">
        <h1>Mes Cinédocs</h1>
        <div class="docs-grid" id="docsGrid">
            <a href="redaction.html" class="new-doc-btn">+</a>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBDE71GtieeUYTR86jUGpRVh0-qTjx5a-c",
            authDomain: "nexuscine-68607.firebaseapp.com",
            projectId: "nexuscine-68607",
            storageBucket: "nexuscine-68607.firebasestorage.app",
            messagingSenderId: "256917505083",
            appId: "1:256917505083:web:f1608ef459ee5b9178481e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        async function hashIP(ip) {
            const encoder = new TextEncoder();
            const data = encoder.encode(ip);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function loadDocs() {
            const status = document.getElementById('status');
            const grid = document.getElementById('docsGrid');

            try {
                const res = await fetch('https://api.ipify.org?format=json');
                const data = await res.json();
                const hashedKey = await hashIP(data.ip);

                const q = query(collection(db, "cinedocs"), where("authorKey", "==", hashedKey));
                const snap = await getDocs(q);
                
                snap.forEach(d => {
                    const docData = d.data();
                    const card = document.createElement('div');
                    card.className = 'doc-card';
                    
                    // Gestion du badge de statut
                    const isPublie = docData.status === 'publie';
                    const badgeClass = isPublie ? 'badge-publie' : 'badge-brouillon';
                    const badgeText = isPublie ? 'PUBLIÉ' : 'BROUILLON';

                    card.innerHTML = `
                        <button class="btn-delete" onclick="window.delDoc('${d.id}')">×</button>
                        <img src="${docData.image || ''}" class="card-img">
                        <div class="card-body">
                            <span class="status-badge ${badgeClass}">${badgeText}</span>
                            <div style="font-size:0.7rem; color:red; font-weight:bold; margin-bottom:5px;">
                                ${docData.genres ? docData.genres.join(' ') : ''}
                            </div>
                            <h3 style="margin:0 0 5px 0; font-size:1.1rem;">${docData.title}</h3>
                            <p style="font-size:0.8rem; color:#666; margin-bottom:15px;">
                                ${docData.director || ''} ${docData.year ? '('+docData.year+')' : ''}
                            </p>
                            <a href="redaction.html?id=${d.id}" class="btn-edit">Modifier / Continuer</a>
                        </div>`;
                    grid.appendChild(card);
                });
                status.innerText = "Session Sécurisée";
            } catch (e) {
                status.innerText = "Erreur de connexion";
                console.error(e);
            }
        }

        window.delDoc = async (id) => {
            if(confirm("Supprimer définitivement ce document ?")) {
                await deleteDoc(doc(db, "cinedocs", id));
                location.reload();
            }
        }

        loadDocs();
    </script>
</body>
</html>
